---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const posts = (await getCollection('posts')).sort(
  (a, b) => b.data.date.valueOf() - a.data.date.valueOf()
);

// 検索用のデータを準備
const searchData = posts.map((post) => ({
  slug: post.slug,
  title: post.data.title,
  description: post.data.description || '',
  date: post.data.date.toISOString(),
  dateFormatted: post.data.date.toLocaleDateString('ja-JP', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  }),
}));
---

<BaseLayout title="検索" description="記事を検索">
  <section>
    <h1 class="text-2xl font-bold mb-8">記事を検索</h1>

    <div class="mb-8">
      <input
        type="text"
        id="search-input"
        placeholder="キーワードを入力..."
        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
      />
    </div>

    <div id="search-results">
      <p class="text-gray-500 text-sm mb-4">
        全 <span id="result-count">{posts.length}</span> 件の記事
      </p>
      <ul id="posts-list" class="space-y-6">
        {searchData.map((post) => (
          <li class="border-b border-gray-100 pb-6 last:border-0 post-item" data-title={post.title.toLowerCase()} data-description={post.description.toLowerCase()}>
            <a
              href={`/daily-commit/posts/${post.slug}/`}
              class="block group"
            >
              <time class="text-sm text-gray-500" datetime={post.date}>
                {post.dateFormatted}
              </time>
              <h2 class="text-lg font-medium mt-1 group-hover:text-blue-600">
                {post.title}
              </h2>
              {post.description && (
                <p class="text-gray-600 text-sm mt-2">
                  {post.description}
                </p>
              )}
            </a>
          </li>
        ))}
      </ul>
    </div>

    <p id="no-results" class="text-gray-500 hidden">
      該当する記事が見つかりませんでした。
    </p>
  </section>
</BaseLayout>

<script>
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const postItems = document.querySelectorAll('.post-item');
  const resultCount = document.getElementById('result-count');
  const noResults = document.getElementById('no-results');
  const postsList = document.getElementById('posts-list');

  searchInput?.addEventListener('input', () => {
    const query = searchInput.value.toLowerCase().trim();
    let visibleCount = 0;

    postItems.forEach((item) => {
      const title = item.getAttribute('data-title') || '';
      const description = item.getAttribute('data-description') || '';
      const isMatch = query === '' || title.includes(query) || description.includes(query);

      if (isMatch) {
        (item as HTMLElement).style.display = 'block';
        visibleCount++;
      } else {
        (item as HTMLElement).style.display = 'none';
      }
    });

    if (resultCount) {
      resultCount.textContent = String(visibleCount);
    }

    if (noResults && postsList) {
      if (visibleCount === 0 && query !== '') {
        noResults.classList.remove('hidden');
        postsList.classList.add('hidden');
      } else {
        noResults.classList.add('hidden');
        postsList.classList.remove('hidden');
      }
    }
  });
</script>
